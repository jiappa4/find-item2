<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê²© ë¹„êµ ê²€ìƒ‰ - ì‹¤ì‹œê°„ ìµœì €ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-500 to-purple-700 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center text-white mb-8">
            <h1 class="text-4xl font-bold mb-2">ğŸ” ê°€ê²© ë¹„êµ ê²€ìƒ‰</h1>
            <p class="text-lg opacity-90">ì‹¤ì‹œê°„ ìµœì €ê°€ ìë™ ìˆ˜ì§‘ ì‹œìŠ¤í…œ (ê³ ê¸‰ ê²€ìƒ‰ ì—”ì§„)</p>
        </div>

        <!-- Search Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex gap-4 mb-4 flex-wrap">
                <input
                    type="text"
                    id="searchQuery"
                    class="flex-1 min-w-[300px] px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-lg"
                    placeholder="ê²€ìƒ‰í•  ìƒí’ˆëª… ì…ë ¥ (ì˜ˆ: ì‹ ì¼ íŒ¬íˆí„° 1200)"
                    value="ì‹ ì¼ íŒ¬íˆí„° 1200"
                    onkeypress="if(event.key==='Enter') searchProducts()"
                />
                <button
                    onclick="searchProducts()"
                    id="searchBtn"
                    class="px-8 py-3 bg-gradient-to-r from-purple-500 to-purple-700 text-white rounded-lg font-semibold hover:shadow-lg transition"
                >
                    ğŸ” ê²€ìƒ‰
                </button>
            </div>
            
            <div class="flex items-center gap-2 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                <span>ğŸ’¡</span>
                <p><strong>AI ê²€ìƒ‰:</strong> ì •í™•ë„ ê¸°ë°˜ í•„í„°ë§ìœ¼ë¡œ ê´€ë ¨ ì—†ëŠ” ìƒí’ˆ ìë™ ì œì™¸ (50ì  ì´ìƒë§Œ í‘œì‹œ)</p>
            </div>

            <!-- API ìƒíƒœ -->
            <div id="apiStatus" class="hidden mt-4 p-3 rounded-lg">
                <div class="flex items-center gap-2">
                    <span id="statusIcon">âš ï¸</span>
                    <span id="statusText" class="font-semibold"></span>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden bg-white rounded-2xl shadow-xl p-16 text-center mb-6">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">ê²€ìƒ‰ ì¤‘...</p>
        </div>

        <!-- Summary -->
        <div id="summary" class="hidden bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-1">ìµœì €ì‹¤í˜„ê°€</div>
                    <div id="lowestPrice" class="text-2xl font-bold text-purple-600">-</div>
                </div>
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-1">í‰ê·  ê°€ê²©</div>
                    <div id="avgPrice" class="text-2xl font-bold text-purple-600">-</div>
                </div>
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-1">ê²€ìƒ‰ ê²°ê³¼</div>
                    <div id="totalCount" class="text-2xl font-bold text-purple-600">0ê°œ</div>
                </div>
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-1">ë¬´ë£Œë°°ì†¡</div>
                    <div id="freeShipping" class="text-2xl font-bold text-purple-600">0%</div>
                </div>
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-1">í‰ê·  ì •í™•ë„</div>
                    <div id="avgRelevance" class="text-2xl font-bold text-green-600">-</div>
                </div>
            </div>
            <div class="mt-4 text-center text-sm text-gray-500">
                <span id="updateTime">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div id="emptyState" class="p-16 text-center">
                <div class="text-6xl mb-4">ğŸ”</div>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">ìƒí’ˆì„ ê²€ìƒ‰í•´ì£¼ì„¸ìš”</h3>
                <p class="text-gray-500">
                    ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”<br/>
                    ë°°ì¹˜ë¡œ ìˆ˜ì§‘ëœ ìµœì‹  ê°€ê²© ì •ë³´ë¥¼ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤
                </p>
            </div>

            <div id="resultsTable" class="hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-purple-500 to-purple-700 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left">ìˆœìœ„</th>
                                <th class="px-4 py-3 text-left">ì •í™•ë„</th>
                                <th class="px-4 py-3 text-left">ì‡¼í•‘ëª°</th>
                                <th class="px-4 py-3 text-left">ìƒí’ˆëª…</th>
                                <th class="px-4 py-3 text-left">ì˜µì…˜</th>
                                <th class="px-4 py-3 text-left">ì •ê°€</th>
                                <th class="px-4 py-3 text-left">í• ì¸ê°€</th>
                                <th class="px-4 py-3 text-left">ë°°ì†¡ë¹„</th>
                                <th class="px-4 py-3 text-left">ìµœì €ì‹¤í˜„ê°€</th>
                                <th class="px-4 py-3 text-left">ë§í¬</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>

                <div class="p-6 bg-gray-50">
                    <h3 class="text-lg font-bold mb-3">ğŸ“Š ë¶„ì„ ìš”ì•½</h3>
                    <ul id="analysisText" class="space-y-2 text-gray-700">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentProducts = [];

        function formatPrice(price) {
            if (!price) return '0ì›';
            return parseInt(price).toLocaleString('ko-KR') + 'ì›';
        }

        function getRankBadge(index) {
            const colors = ['#FFD700', '#C0C0C0', '#CD7F32', '#667eea'];
            const color = colors[Math.min(index, 3)];
            return `<div class="flex items-center justify-center w-8 h-8 rounded-full text-white font-bold" style="background: ${color}">${index + 1}</div>`;
        }

        function getRelevanceBadge(score) {
            let color, text;
            if (score >= 90) {
                color = 'bg-green-500';
                text = 'ì™„ë²½';
            } else if (score >= 80) {
                color = 'bg-green-400';
                text = 'ë§¤ìš°ë†’ìŒ';
            } else if (score >= 70) {
                color = 'bg-blue-500';
                text = 'ë†’ìŒ';
            } else if (score >= 60) {
                color = 'bg-yellow-500';
                text = 'ë³´í†µ';
            } else {
                color = 'bg-orange-500';
                text = 'ë‚®ìŒ';
            }
            
            return `
                <div class="flex flex-col items-center gap-1">
                    <span class="px-3 py-1 ${color} text-white rounded-full text-sm font-bold">
                        ${score.toFixed(1)}ì 
                    </span>
                    <span class="text-xs text-gray-500">${text}</span>
                </div>
            `;
        }

        function showApiStatus(type, message) {
            const statusDiv = document.getElementById('apiStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            
            statusDiv.classList.remove('hidden', 'bg-red-50', 'bg-green-50', 'bg-yellow-50');
            
            if (type === 'error') {
                statusDiv.classList.add('bg-red-50');
                statusIcon.textContent = 'âŒ';
                statusText.textContent = message;
                statusText.className = 'font-semibold text-red-700';
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-50');
                statusIcon.textContent = 'âœ…';
                statusText.textContent = message;
                statusText.className = 'font-semibold text-green-700';
            } else {
                statusDiv.classList.add('bg-yellow-50');
                statusIcon.textContent = 'âš ï¸';
                statusText.textContent = message;
                statusText.className = 'font-semibold text-yellow-700';
            }
        }

        async function searchProducts() {
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // UI ì´ˆê¸°í™”
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('resultsTable').classList.add('hidden');
            document.getElementById('summary').classList.add('hidden');
            document.getElementById('apiStatus').classList.add('hidden');
            document.getElementById('searchBtn').disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(query)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                currentProducts = data.products || [];

                if (currentProducts.length === 0) {
                    showApiStatus('warning', 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. backend/run_scraper.batì„ ì‹¤í–‰í•˜ì—¬ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•´ì£¼ì„¸ìš”.');
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    showApiStatus('success', `${currentProducts.length}ê°œì˜ ìƒí’ˆì„ ì°¾ì•˜ìŠµë‹ˆë‹¤! (ì •í™•ë„ ê¸°ë°˜ í•„í„°ë§ ì ìš©)`);
                    renderResults(data);
                }

            } catch (error) {
                console.error('Error:', error);
                showApiStatus('error', `API ì„œë²„ ì˜¤ë¥˜: ${error.message}`);
                document.getElementById('emptyState').classList.remove('hidden');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('searchBtn').disabled = false;
            }
        }

        function renderResults(data) {
            const products = data.products;
            const summary = data.summary;

            // Summary ì—…ë°ì´íŠ¸
            if (summary) {
                document.getElementById('lowestPrice').textContent = formatPrice(summary.lowestPrice);
                document.getElementById('avgPrice').textContent = formatPrice(summary.avgPrice);
                document.getElementById('totalCount').textContent = summary.totalCount + 'ê°œ';
                document.getElementById('freeShipping').textContent = summary.freeShippingRate + '%';
                document.getElementById('avgRelevance').textContent = (summary.avgRelevance || 0).toFixed(1) + 'ì ';
                document.getElementById('summary').classList.remove('hidden');
            }

            // ì—…ë°ì´íŠ¸ ì‹œê°„
            const updateTime = new Date(data.updatedAt).toLocaleString('ko-KR');
            document.getElementById('updateTime').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${updateTime} | ê²€ìƒ‰ ë°©ì‹: ${data.searchMethod === 'advanced' ? 'AI ê³ ê¸‰ ê²€ìƒ‰' : 'ê¸°ë³¸ ê²€ìƒ‰'}`;

            // í…Œì´ë¸” ë Œë”ë§
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = products.map((item, index) => `
                <tr class="border-b hover:bg-gray-50 fade-in">
                    <td class="px-4 py-3">${getRankBadge(index)}</td>
                    <td class="px-4 py-3">${getRelevanceBadge(item.relevanceScore || 0)}</td>
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 bg-gray-100 rounded-full text-sm font-semibold">
                            ${item.shop}
                        </span>
                    </td>
                    <td class="px-4 py-3 font-medium">${item.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${item.option || 'ë‹¨ì¼'}</td>
                    <td class="px-4 py-3 text-gray-400 line-through text-sm">
                        ${formatPrice(item.originalPrice)}
                    </td>
                    <td class="px-4 py-3 text-pink-600 font-semibold">
                        ${formatPrice(item.discountPrice)}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                            item.shipping === 0 ? 'bg-green-500 text-white' : 'bg-orange-500 text-white'
                        }">
                            ${item.shipping === 0 ? 'ë¬´ë£Œ' : formatPrice(item.shipping)}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-purple-600 font-bold text-lg">
                        ${formatPrice(item.finalPrice)}
                    </td>
                    <td class="px-4 py-3">
                        ${item.link ? `
                            <a href="${item.link}" target="_blank" rel="noopener noreferrer"
                               class="px-3 py-1 bg-purple-500 text-white rounded text-sm hover:bg-purple-600">
                                ì´ë™
                            </a>
                        ` : '<span class="text-gray-400 text-sm">-</span>'}
                    </td>
                </tr>
            `).join('');

            // ë¶„ì„ í…ìŠ¤íŠ¸
            const priceDiff = products[products.length - 1].finalPrice - products[0].finalPrice;
            const freeShippingCount = products.filter(p => p.shipping === 0).length;
            const avgRelevance = summary.avgRelevance || 0;
            
            document.getElementById('analysisText').innerHTML = `
                <li><strong>ìµœì €ì‹¤í˜„ê°€:</strong> ${products[0].shop}ì—ì„œ ${formatPrice(products[0].finalPrice)}</li>
                <li><strong>ê°€ê²© ë²”ìœ„:</strong> ${formatPrice(products[0].finalPrice)} ~ ${formatPrice(products[products.length - 1].finalPrice)}</li>
                <li><strong>ê°€ê²© ì°¨ì´:</strong> ${formatPrice(priceDiff)} (${((priceDiff/products[0].finalPrice)*100).toFixed(1)}%)</li>
                <li><strong>ë¬´ë£Œë°°ì†¡:</strong> ${freeShippingCount}ê°œ / ${products.length}ê°œ (${summary.freeShippingRate}%)</li>
                <li><strong>í‰ê·  ì •í™•ë„:</strong> ${avgRelevance.toFixed(1)}ì  (50ì  ì´ìƒë§Œ í‘œì‹œ)</li>
            `;

            document.getElementById('resultsTable').classList.remove('hidden');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API ìƒíƒœ ì²´í¬
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    showApiStatus('success', 'API ì„œë²„ ì—°ê²° ì™„ë£Œ');
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                showApiStatus('error', 'API ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. backend/run_api.batì„ ì‹¤í–‰í•˜ì„¸ìš”.');
            }
        }

        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            checkApiStatus();
        });
    </script>
</body>
</html>
